<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinador de Notas Musicais</title>
    <style>
        :root {
            --color-primary: #218084;
            --color-primary-hover: #1a6670;
            --color-success: #22c55e;
            --color-error: #ef4444;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #666666;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --radius-lg: 12px;
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --duration-fast: 150ms;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-20);
        }

        .container {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-24);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        h1 {
            margin: 0 0 var(--space-24) 0;
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--duration-fast) ease;
            margin: var(--space-16) 8px;
            min-width: 140px;
        }

        .button-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .button-primary:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(33, 128, 132, 0.3);
        }

        .button-primary:active {
            transform: translateY(0);
        }

        .button-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-secondary {
            background-color: #e5e5e5;
            color: var(--color-text);
        }

        .button-secondary:hover {
            background-color: #d5d5d5;
            transform: translateY(-2px);
        }

        .status-section {
            margin: var(--space-24) 0;
            padding: var(--space-20);
            background: #f9f9f9;
            border-radius: var(--radius-lg);
            border: 2px solid #e5e5e5;
            transition: all var(--duration-fast) ease;
        }

        .note-display {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin: var(--space-16) 0;
            font-family: monospace;
        }

        .feedback {
            font-size: 16px;
            font-weight: 500;
            margin: var(--space-16) 0;
            min-height: 24px;
            transition: color var(--duration-fast) ease;
        }

        .feedback.success {
            color: var(--color-success);
        }

        .feedback.error {
            color: var(--color-error);
        }

        .feedback.info {
            color: var(--color-text-secondary);
        }

        .frequency-display {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin: var(--space-16) 0;
            font-family: monospace;
        }

        .message {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin: var(--space-16) 0;
            line-height: 1.6;
        }

        .status-active {
            border-color: var(--color-primary);
            background: rgba(33, 128, 132, 0.05);
        }

        .indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .indicator.listening {
            background-color: var(--color-primary);
        }

        .indicator.success {
            background-color: var(--color-success);
            animation: none;
        }

        .indicator.error {
            background-color: var(--color-error);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-button {
            background-color: #e5e5e5;
            color: var(--color-text);
            font-size: 14px;
            padding: 10px 16px;
            transition: all var(--duration-fast) ease;
        }

        .option-button:hover {
            background-color: #d5d5d5;
        }

        .option-button.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 4px 8px rgba(33, 128, 132, 0.3);
        }

        .note-list {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: var(--space-16);
            padding-top: var(--space-16);
            border-top: 1px solid #e5e5e5;
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--color-error);
            padding: var(--space-16);
            border-radius: 4px;
            margin: var(--space-16) 0;
            text-align: left;
            color: var(--color-error);
            font-size: 14px;
        }

        .success-message {
            background-color: rgba(34, 197, 94, 0.1);
            border-left: 4px solid var(--color-success);
            padding: var(--space-16);
            border-radius: 4px;
            margin: var(--space-16) 0;
            text-align: left;
            color: var(--color-success);
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                padding: var(--space-16);
            }

            h1 {
                font-size: 24px;
            }

            .button {
                font-size: 14px;
                padding: 10px 20px;
                min-width: 120px;
            }

            .note-display {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽµ Treinador de Notas</h1>

        <div id="menuSection" style="display: block;">
            <div class="status-section">
                <div class="message" style="margin-bottom: var(--space-20); font-weight: 500;">Escolha o formato das notas:</div>
                
                <div style="margin-bottom: var(--space-20);">
                    <label style="display: block; margin-bottom: var(--space-12); font-weight: 500;">NotaÃ§Ã£o:</label>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="button option-button" data-notation="letters" style="flex: 1; min-width: 120px;">Letras (C, D, E...)</button>
                        <button class="button option-button" data-notation="solfege" style="flex: 1; min-width: 120px;">Cifras (DÃ³, RÃ©, Mi...)</button>
                    </div>
                </div>

                <div id="clefSection" style="margin-bottom: var(--space-20);">
                    <label style="display: block; margin-bottom: var(--space-12); font-weight: 500;">Clave:</label>
                    <div id="clefButtons" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="button option-button" data-clef="treble" style="flex: 1; min-width: 120px;">ðŸŽ¼ Clave de Sol</button>
                        <button class="button option-button" data-clef="bass" style="flex: 1; min-width: 120px;">ðŸŽ¼ Clave de FÃ¡</button>
                    </div>
                    <div id="bothClevesInfo" style="display: none; margin-top: var(--space-12); padding: var(--space-12); background: rgba(33, 128, 132, 0.1); border-radius: var(--radius-lg); color: var(--color-text-secondary); font-size: 14px;">
                        Mostrando as duas claves (Sol e FÃ¡)
                    </div>
                </div>

                <div class="controls" style="margin-top: var(--space-24);">
                    <button class="button button-primary" id="startBtn">Iniciar Treinamento</button>
                </div>
            </div>
        </div>

        <div id="statusSection" style="display: none;">
            <div class="message" id="initialMessage">
                Clique em "Iniciar" para comeÃ§ar o treinamento. VocÃª precisarÃ¡ permitir o acesso ao microfone.
            </div>
            <div class="note-list">Notas disponÃ­veis: A, A#, B, C, C#, D, D#, E, F, F#, G, G#</div>
        </div>

        <div id="trainingContent" style="display: none;">
            <div class="status-section status-active">
                <div style="margin-bottom: var(--space-16); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span class="indicator listening"></span>
                        <span id="statusText" style="font-weight: 500;">Procurando nota...</span>
                    </div>
                    <button class="button button-secondary" id="stopBtn" style="padding: 8px 16px; font-size: 14px; margin: 0;">Sair</button>
                </div>
                <div class="note-display" id="targetNote">C</div>
                <div class="message">Toque a nota acima no seu instrumento</div>
                <div class="frequency-display" id="frequencyDisplay"></div>
            </div>

            <div class="status-section">
                <div class="feedback" id="feedback"></div>
                <div id="errorDetails" style="font-size: 12px; color: var(--color-error); margin-top: 8px;"></div>
            </div>

            <div class="status-section">
                <div style="font-size: 14px; color: var(--color-text-secondary);">
                    Tentativas: <strong id="attempts">0</strong>
                </div>
            </div>
        </div>

        <div id="errorSection" style="display: none;">
            <div class="error-message" id="errorMessage"></div>
        </div>
    </div>

    <script>
        // FrequÃªncias das notas (escala cromÃ¡tica)
        const NOTE_FREQUENCIES = {
            'C': 261.63,
            'C#': 277.18,
            'D': 293.66,
            'D#': 311.13,
            'E': 329.63,
            'F': 349.23,
            'F#': 369.99,
            'G': 392.00,
            'G#': 415.30,
            'A': 440.00,
            'A#': 466.16,
            'B': 493.88
        };

        const NOTES = Object.keys(NOTE_FREQUENCIES);

        let audioContext;
        let analyser;
        let microphone;
        let isRunning = false;
        let currentTargetNote = null;
        let attempts = 0;
        let animationId = null;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusSection = document.getElementById('statusSection');
        const trainingContent = document.getElementById('trainingContent');
        const errorSection = document.getElementById('errorSection');
        const targetNoteDisplay = document.getElementById('targetNote');
        const feedbackDisplay = document.getElementById('feedback');
        const errorDetailsDisplay = document.getElementById('errorDetails');
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        const statusText = document.getElementById('statusText');
        const attemptsDisplay = document.getElementById('attempts');
        const menuSection = document.getElementById('menuSection');

        let userNotation = 'letters';
        let userClef = 'treble';

        startBtn.addEventListener('click', startTraining);
        stopBtn.addEventListener('click', stopTraining);

        // Menu options
        document.querySelectorAll('.option-button[data-notation]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.option-button[data-notation]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                userNotation = this.dataset.notation;
                updateClefDisplay();
            });
        });

        function updateClefDisplay() {
            const clefSection = document.getElementById('clefSection');
            const clefButtons = document.getElementById('clefButtons');
            const bothClevesInfo = document.getElementById('bothClevesInfo');
            
            if (userNotation === 'solfege') {
                clefButtons.style.display = 'none';
                bothClevesInfo.style.display = 'block';
                userClef = 'both';
            } else {
                clefButtons.style.display = 'flex';
                bothClevesInfo.style.display = 'none';
                userClef = 'treble'; // reset to default
                document.querySelectorAll('.option-button[data-clef]').forEach(b => b.classList.remove('active'));
                document.querySelector('.option-button[data-clef="treble"]').classList.add('active');
            }
        }

        document.querySelectorAll('.option-button[data-clef]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.option-button[data-clef]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                userClef = this.dataset.clef;
            });
        });

        // Set initial active buttons
        document.querySelector('.option-button[data-notation="letters"]').classList.add('active');
        document.querySelector('.option-button[data-clef="treble"]').classList.add('active');

        function showError(message) {
            errorSection.style.display = 'block';
            statusSection.style.display = 'none';
            trainingContent.style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        async function startTraining() {
            try {
                // Criar contexto de Ã¡udio
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;

                // Obter acesso ao microfone
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                isRunning = true;
                stopBtn.disabled = false;
                errorSection.style.display = 'none';
                menuSection.style.display = 'none';
                statusSection.style.display = 'none';
                trainingContent.style.display = 'block';
                attempts = 0;
                attemptsDisplay.textContent = '0';

                pickNewNote();
                detectPitch();
            } catch (error) {
                showError('Erro ao acessar o microfone. Verifique as permissÃµes do navegador.');
                console.error(error);
            }
        }

        function stopTraining() {
            isRunning = false;
            stopBtn.disabled = true;

            if (microphone) {
                microphone.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }

            menuSection.style.display = 'block';
            trainingContent.style.display = 'none';
            errorSection.style.display = 'none';
        }

        function getDisplayNote(note, clef = null) {
            if (userNotation === 'solfege') {
                const solfegeMap = {
                    'C': 'DÃ³', 'C#': 'DÃ³#', 'D': 'RÃ©', 'D#': 'RÃ©#', 'E': 'Mi',
                    'F': 'FÃ¡', 'F#': 'FÃ¡#', 'G': 'Sol', 'G#': 'Sol#', 'A': 'LÃ¡', 'A#': 'LÃ¡#', 'B': 'Si'
                };
                if (userClef === 'both') {
                    // Mostra em ambas as claves
                    return `${solfegeMap[note]} ðŸŽ¼`;
                }
                return solfegeMap[note] || note;
            }
            return note;
        }

        function pickNewNote() {
            currentTargetNote = NOTES[Math.floor(Math.random() * NOTES.length)];
            let displayNote = getDisplayNote(currentTargetNote);
            
            if (userNotation === 'solfege' && userClef === 'both') {
                const solfegeMap = {
                    'C': 'DÃ³', 'C#': 'DÃ³#', 'D': 'RÃ©', 'D#': 'RÃ©#', 'E': 'Mi',
                    'F': 'FÃ¡', 'F#': 'FÃ¡#', 'G': 'Sol', 'G#': 'Sol#', 'A': 'LÃ¡', 'A#': 'LÃ¡#', 'B': 'Si'
                };
                displayNote = `${solfegeMap[currentTargetNote]}\n(Sol e FÃ¡)`;
            }
            
            targetNoteDisplay.textContent = displayNote;
            feedbackDisplay.textContent = '';
            feedbackDisplay.className = 'feedback';
            errorDetailsDisplay.textContent = '';
            attempts++;
            attemptsDisplay.textContent = attempts.toString();
            statusText.textContent = 'Procurando nota...';
            frequencyDisplay.textContent = '';
        }

        function detectPitch() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const buffer = new Float32Array(analyser.fftSize);
            analyser.getFloatTimeDomainData(buffer);

            const frequency = autoCorrelate(buffer, audioContext.sampleRate);

            if (frequency > 0) {
                const detectedNote = frequencyToNote(frequency);
                const detectedFreq = NOTE_FREQUENCIES[detectedNote];
                const cents = 1200 * Math.log2(frequency / detectedFreq);

                frequencyDisplay.textContent = `${frequency.toFixed(1)} Hz â†’ ${detectedNote} (${cents > 0 ? '+' : ''}${cents.toFixed(0)} cents)`;

                if (detectedNote === currentTargetNote) {
                    // Verifica se estÃ¡ dentro de uma tolerÃ¢ncia razoÃ¡vel (Â±50 cents)
                    if (Math.abs(cents) < 50) {
                        feedbackDisplay.textContent = 'âœ“ Correto! PrÃ³xima nota...';
                        feedbackDisplay.className = 'feedback success';
                        statusText.textContent = 'ParabÃ©ns!';
                        
                        setTimeout(() => {
                            if (isRunning) {
                                pickNewNote();
                                detectPitch();
                            }
                        }, 1500);
                        return;
                    }
                }

                feedbackDisplay.textContent = 'âœ— Nota incorreta. Tente novamente.';
                feedbackDisplay.className = 'feedback error';
                const detectedDisplay = getDisplayNote(detectedNote);
                const expectedDisplay = getDisplayNote(currentTargetNote);
                errorDetailsDisplay.textContent = `VocÃª tocou: ${detectedDisplay} | Esperado: ${expectedDisplay}`;
                statusText.textContent = `Ouvido: ${detectedDisplay}`;
            } else {
                feedbackDisplay.textContent = '';
                frequencyDisplay.textContent = 'Esperando som...';
                statusText.textContent = 'Procurando nota...';
            }

            if (isRunning) {
                animationId = requestAnimationFrame(detectPitch);
            }
        }

        function autoCorrelate(buffer, sampleRate) {
            // ImplementaÃ§Ã£o do algoritmo de autocorrelaÃ§Ã£o para detectar pitch
            let SIZE = buffer.length;
            let MAX_SAMPLES = Math.floor(SIZE / 2);
            let best_offset = -1;
            let best_correlation = 0;
            let rms = 0;

            // Calcula o RMS (Root Mean Square) do buffer
            for (let i = 0; i < SIZE; i++) {
                let val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / SIZE);

            // NÃ£o detecta se o sinal Ã© muito fraco
            if (rms < 0.01) return -1;

            // Procura pelo melhor offset
            let lastCorrelation = 1;
            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;
                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - (correlation / MAX_SAMPLES);
                if (correlation > 0.9) {
                    if (correlation > lastCorrelation) {
                        let foundGoodCorrelation = false;
                        if (correlation > best_correlation) {
                            best_correlation = correlation;
                            best_offset = offset;
                            foundGoodCorrelation = true;
                        }
                        if (foundGoodCorrelation) {
                            let shift = (buffer[best_offset + 1] - buffer[best_offset]) / (2 * (2 * buffer[best_offset] - buffer[best_offset + 1] - buffer[best_offset - 1]));
                            return sampleRate / (best_offset + (8 * shift));
                        }
                    }
                }
                lastCorrelation = correlation;
            }

            if (best_correlation > 0.01) {
                return sampleRate / best_offset;
            }
            return -1;
        }

        function frequencyToNote(frequency) {
            // Encontra a nota mais prÃ³xima para a frequÃªncia detectada
            let closestNote = NOTES[0];
            let closestDistance = Math.abs(frequency - NOTE_FREQUENCIES[closestNote]);

            for (let note of NOTES) {
                let distance = Math.abs(frequency - NOTE_FREQUENCIES[note]);
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestNote = note;
                }
            }

            return closestNote;
        }
    </script>
</body>
</html>
